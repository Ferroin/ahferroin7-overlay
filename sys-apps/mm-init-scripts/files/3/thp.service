[Unit]
Description='Configure Transparent Hugepage settings'
RequiresMountsFor=/sys/kernel/mm /run
ConditionUser=@system
AssertPathExists=/etc/conf.d/thp
AssertDirectoryNotEmpty=/sys/kernel/mm/transparent_hugepage

[Service]
Type=oneshot
RemainAfterExit=yes

ExecStartPre=/bin/sh -c 'echo "THP_DEFRAG=$(cat /sys/kernel/mm/transparent_hugepage/defrag)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_DEFRAG} ] && echo "${THP_DEFRAG}" > /sys/kernel/mm/transparent_hugepage/defrag'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_DEFRAG} ] && echo "${THP_DEFRAG}" > /sys/kernel/mm/transparent_hugepage/defrag'

ExecStartPre=/bin/sh -c 'echo "THP_SHMEM=$(cat /sys/kernel/mm/transparent_hugepage/shmem_enabled)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_SHMEM} ] && echo "${THP_SHMEM}" > /sys/kernel/mm/transparent_hugepage/shmem_enabled'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_SHMEM} ] && echo "${THP_SHMEM}" > /sys/kernel/mm/transparent_hugepage/shmem_enabled'

ExecStartPre=/bin/sh -c 'echo "THP_USE_ZERO_PAGE=$(cat /sys/kernel/mm/transparent_hugepage/use_zero_page)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_USE_ZERO_PAGE} ] && echo "${THP_USE_ZERO_PAGE}" > /sys/kernel/mm/transparent_hugepage/use_zero_page'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_USE_ZERO_PAGE} ] && echo "${THP_USE_ZERO_PAGE}" > /sys/kernel/mm/transparent_hugepage/use_zero_page'

ExecStartPre=/bin/sh -c 'echo "THP_MODE=$(cat /sys/kernel/mm/transparent_hugepage/enable)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && echo "${THP_MODE:-madvise}" > /sys/kernel/mm/transparent_hugepage/enable'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_MODE} ] && echo "${THP_MODE}" > /sys/kernel/mm/transparent_hugepage/enable'

ExecStartPre=/bin/sh -c 'echo "THP_KHUGEPAGED_PAGES_TO_SCAN=$(cat /sys/kernel/mm/transparent_hugepage/khugepaged/pages_to_scan)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_KHUGEPAGED_PAGES_TO_SCAN} ] && echo "${THP_KHUGEPAGED_PAGES_TO_SCAN}" > /sys/kernel/mm/transparent_hugepage/khugepaged/pages_to_scan'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_KHUGEPAGED_PAGES_TO_SCAN} ] && echo "${THP_KHUGEPAGED_PAGES_TO_SCAN}" > /sys/kernel/mm/transparent_hugepage/khugepaged/pages_to_scan'

ExecStartPre=/bin/sh -c 'echo "THP_KHUGEPAGED_SCAN_SLEEP_MILLISECS=$(cat /sys/kernel/mm/transparent_hugepage/khugepaged/scan_sleep_millisecs)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_KHUGEPAGED_SCAN_SLEEP_MILLISECS} ] && echo "${THP_KHUGEPAGED_SCAN_SLEEP_MILLISECS}" > /sys/kernel/mm/transparent_hugepage/khugepaged/scan_sleep_millisecs'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_KHUGEPAGED_SCAN_SLEEP_MILLISECS} ] && echo "${THP_KHUGEPAGED_SCAN_SLEEP_MILLISECS}" > /sys/kernel/mm/transparent_hugepage/khugepaged/scan_sleep_millisecs'

ExecStartPre=/bin/sh -c 'echo "THP_KHUGEPAGED_ALLOC_SLEEP_MILLISECS=$(cat /sys/kernel/mm/transparent_hugepage/khugepaged/alloc_sleep_millisecs)" > /run/thp.defaults'
ExecStart=/bin/sh -c '. /etc/conf.d/thp && [ -n ${THP_KHUGEPAGED_ALLOC_SLEEP_MILLISECS} ] && echo "${THP_KHUGEPAGED_ALLOC_SLEEP_MILLISECS}" > /sys/kernel/mm/transparent_hugepage/khugepaged/alloc_sleep_millisecs'
ExecStop=/bin/sh -c '. /run/thp.defaults && [ -n ${THP_KHUGEPAGED_ALLOC_SLEEP_MILLISECS} ] && echo "${THP_KHUGEPAGED_ALLOC_SLEEP_MILLISECS}" > /sys/kernel/mm/transparent_hugepage/khugepaged/alloc_sleep_millisecs'

[Install]
WantedBy=basic.target
